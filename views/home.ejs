<%- include("partials/header.ejs") %>
<body>
<%- include("partials/nav_bar.ejs") %>

<div class="container mt-4">

  <h1 class="mb-4">Gal_Tracker!</h1>

  <!-- ================================
       SEARCH FOOD (API)
  ================================ -->
  <section class="mb-5">
    <h2>Search Foods (Public API)</h2>

    <input id="foodSearchInput" class="form-control mb-3" type="text" placeholder="Search for food...">

    <button id="foodSearchBtn" class="btn btn-primary mb-3">Search</button>

    <ul id="foodResults" class="list-group"></ul>
  </section>


  <!-- ================================
       MACRO TRACKER
  ================================ -->
  <section class="mb-5">
    <h2>Macro_Tracker</h2>

    <!-- Add Food Form -->
    <form action="/addFood" method="POST" class="mb-3">
      <div class="row g-3">

        <div class="col-md-3">
          <input type="text" name="name" class="form-control" placeholder="Name" required>
        </div>

        <div class="col-md-2">
          <input type="number" name="calories" class="form-control" placeholder="Calories" step="0.01">
        </div>

        <div class="col-md-2">
          <input type="number" name="protein" class="form-control" placeholder="Protein (g)" step="0.01">
        </div>

        <div class="col-md-2">
          <input type="number" name="carbs" class="form-control" placeholder="Carbs (g)" step="0.01">
        </div>

        <div class="col-md-2">
          <input type="number" name="fat" class="form-control" placeholder="Fat (g)" step="0.01">
        </div>

        <div class="col-md-2">
          <input type="number" name="sodium" class="form-control" placeholder="Sodium (mg)" step="0.01">
        </div>

        <div class="col-md-2">
          <select name="mealType" class="form-select">
            <option>meal_type</option>
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Snack</option>
          </select>
        </div>

        <div class="col-md-3">
          <input type="date" name="entryDate" class="form-control">
        </div>

        <div class="col-md-2">
          <button class="btn btn-success w-100">Add Food</button>
        </div>

      </div>
    </form>

    <!-- FOOD TABLE -->
    <table class="table table-dark table-striped mt-3">
      <thead>
        <tr>
          <th>Food</th>
          <th>Calories</th>
          <th>Protein</th>
          <th>Carbs</th>
          <th>Fat</th>
          <th>Sodium</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <% if (foods && foods.length > 0) { %>
          <% foods.forEach(food => { %>
            <tr>
              <td><%= food.name %></td>
              <td><%= food.calories %></td>
              <td><%= food.protein %></td>
              <td><%= food.carbs %></td>
              <td><%= food.fat %></td>
              <td><%= food.sodium %></td>
              <td><%= food.entryDate.toISOString().split("T")[0] %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7" class="text-center">No food entries yet.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </section>


  <!-- ================================
       GYM LOG
  ================================ -->
  <section class="mt-5">
    <h2>Gym_Log</h2>

    <!-- Add Gym Log Form -->
    <form action="/addGymLog" method="POST" class="mb-3">
      <div class="row g-3">

        <div class="col-md-3">
          <input type="text" name="exercise" class="form-control" placeholder="Exercise">
        </div>

        <div class="col-md-2">
          <input type="number" name="weight" class="form-control" placeholder="Weight" step="0.01">
        </div>

        <div class="col-md-2">
          <input type="number" name="reps" class="form-control" placeholder="Reps">
        </div>

        <div class="col-md-3">
          <input type="date" name="entryDate" class="form-control">
        </div>

        <div class="col-md-2">
          <button class="btn btn-primary w-100">Add Log</button>
        </div>

      </div>
    </form>

    <!-- GYM TABLE -->
    <table class="table table-dark table-striped mt-3">
      <thead>
        <tr>
          <th>Exercise</th>
          <th>Weight</th>
          <th>Reps</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <% if (logs && logs.length > 0) { %>
          <% logs.forEach(log => { %>
            <tr>
              <td><%= log.exercise %></td>
              <td><%= log.weight %></td>
              <td><%= log.reps %></td>
              <td><%= log.entryDate.toISOString().split("T")[0] %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="4" class="text-center">No gym logs yet.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </section>

</div>

<%- include("partials/footer.ejs") %>

<!-- ================================
     JS FOR FOOD API SEARCH
================================ -->
<script>
  const searchBtn = document.getElementById("foodSearchBtn");
  const searchInput = document.getElementById("foodSearchInput");
  const resultsList = document.getElementById("foodResults");

  searchBtn.addEventListener("click", async () => {
    const query = searchInput.value.trim();
    if (!query) return;

    const res = await fetch(`/searchFood?query=${encodeURIComponent(query)}`);
    const foods = await res.json();

    resultsList.innerHTML = "";

    if (foods.length === 0) {
      resultsList.innerHTML = `<li class="list-group-item">No results found.</li>`;
      return;
    }

    foods.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.style.cursor = "pointer";

      li.textContent = `${item.name} â€” ${item.calories} cal`;

      li.addEventListener("click", async () => {
        const insertRes = await fetch("/addFoodFromSearch", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(item)
        });

        if (insertRes.ok) {
          alert(`${item.name} added!`);
          window.location.reload();
        } else {
          alert("Error adding food.");
        }
      });

      resultsList.appendChild(li);
    });
  });
</script>

</body>
